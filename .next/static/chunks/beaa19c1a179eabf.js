(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,69439,e=>{"use strict";var t=e.i(3008),r=e.i(21453);e.i(37181);var i=e.i(4977),n=e.i(28463),l=e.i(81304),o=e.i(71153),c=e.i(79317),s=e.i(42537),a=e.i(39911),d=e.i(49830),u=e.i(57512),h=e.i(27808),p=e.i(15745),f=e.i(9165),m=e.i(20437),y=e.i(15236),x=e.i(55379);function j(){let e=(0,s.useRouter)(),{cart:j}=(0,y.useCart)(),[g,k]=(0,r.useState)(0),[S,B]=(0,r.useState)("RUB"),[U,C]=(0,r.useState)(!1),[v,b]=(0,r.useState)(null),[w,I]=(0,r.useState)(null),[R,T]=(0,r.useState)(null),[P,z]=(0,r.useState)(!1),K=(0,r.useRef)(!1);(0,r.useEffect)(()=>{let t=(0,m.getCart)();0===t.length?e.replace("/cart"):(async()=>{try{let e=await (0,f.apiGet)("/api/products"),r=0,i="RUB";for(let n of t){let t=e.find(e=>e.id===n.productId);t&&(r+=t.priceKopeks*n.qty,i=t.currency)}k(r),B(i)}catch(e){console.error(e),b("Не удалось проверить корзину")}})()},[e]);let q=async()=>{if(!U){if(!j.length)return void b("Корзина пуста. Добавьте товары перед оформлением заказа.");if(!P)return void b("Необходимо согласиться с условиями публичной оферты.");C(!0),b(null);try{let t=window.crypto?.randomUUID?window.crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,r=await (0,f.apiPost)("/api/orders",{items:j.map(e=>({productId:e.productId,qty:e.qty}))},{auth:!0,idempotencyKey:t});(0,m.clear)(),I(r.orderId),T(r.paymentUrl??null),r.paymentUrl&&!K.current&&(K.current=!0,(0,x.openExternal)(r.paymentUrl)),e.push(`/orders/${r.orderId}`)}catch(t){console.error(t);let e=t?.status;401===e||403===e?b("Не удалось подтвердить авторизацию в Telegram. Откройте мини‑приложение из Telegram и попробуйте ещё раз."):e&&e>=500?b("Сервис временно недоступен. Попробуйте позже."):b(t?.message??"Ошибка при создании заказа")}finally{C(!1)}}},A=(0,t.jsxs)("div",{children:[g>0&&(0,t.jsxs)("div",{style:{marginBottom:12,fontSize:18,fontWeight:600},children:["Сумма к оплате: ",(0,t.jsx)(h.Price,{amountKopeks:g,currency:S})]}),w?R?(0,t.jsx)(i.Button,{size:"m",mode:"filled",stretched:!0,onClick:()=>(0,x.openExternal)(R),children:"Открыть оплату ещё раз"}):(0,t.jsx)(u.Banner,{type:"info",className:"app-shell__sticky-bottom-banner",children:"Заказ создан. Если окно оплаты не открылось, проверьте статус заказа."}):(0,t.jsx)(i.Button,{size:"m",mode:"filled",stretched:!0,loading:U,disabled:U||!P,onClick:q,children:U?"Создаём заказ…":"Создать заказ"})]});return(0,t.jsx)(a.Page,{children:(0,t.jsx)(d.AppShell,{title:"Оформление заказа",stickyBottom:A,children:(0,t.jsxs)(n.List,{children:[(0,t.jsxs)(l.Section,{header:"Детали заказа",children:[v&&(0,t.jsx)(u.Banner,{type:"error",children:v}),w&&!R&&(0,t.jsxs)(u.Banner,{type:"success",children:["Заказ №",w," создан. Ожидайте открытия окна оплаты."]})]}),(0,t.jsx)(l.Section,{children:(0,t.jsxs)(c.Cell,{before:(0,t.jsx)(o.Checkbox,{checked:P,onChange:e=>{z(e.target.checked)}}),after:(0,t.jsx)(p.Link,{href:"/oferta",style:{fontSize:"12px",color:"var(--tg-theme-link-color, #2481cc)"},children:"Прочитать"}),onClick:()=>z(!P),children:["Я согласен с условиями"," ",(0,t.jsx)(p.Link,{href:"/oferta",style:{color:"var(--tg-theme-link-color, #2481cc)"},children:"публичной оферты"})]})})]})})})}e.s(["default",()=>j])}]);