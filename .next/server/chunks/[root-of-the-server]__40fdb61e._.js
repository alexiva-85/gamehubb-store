module.exports=[18622,(e,t,r)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},70406,(e,t,r)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},93695,(e,t,r)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},54799,(e,t,r)=>{t.exports=e.x("crypto",()=>require("crypto"))},29173,(e,t,r)=>{t.exports=e.x("@prisma/client",()=>require("@prisma/client"))},37219,90177,e=>{"use strict";var t=e.i(29173);let r=new Proxy({},{get(e,r){let a=globalThis.__prisma?globalThis.__prisma:new t.PrismaClient({log:["error"]}),n=a[r];return"function"==typeof n?n.bind(a):n}});e.s(["prisma",0,r],90177),e.s([],37219)},54478,e=>{"use strict";e.i(37219);var t=e.i(90177);class r{name="mock";async fulfill(e){let{orderId:t,productId:r,quantity:a}=e,n=2e3*Math.random()+1e3;if(await new Promise(e=>setTimeout(e,n)),Math.random()>.05){let e=`MOCK-${t}-${Date.now()}-${Math.random().toString(36).substring(7)}`;return console.log(`[Mock Fulfillment] Order ${t} fulfilled successfully`,{productId:r,quantity:a,transactionId:e}),{success:!0,transactionId:e,message:`Mock fulfillment completed for order ${t}`,metadata:{provider:"mock",fulfilledAt:new Date().toISOString(),productId:r,quantity:a}}}{let e=["Insufficient stock","Product temporarily unavailable","Processing timeout","Invalid product configuration"],n=e[Math.floor(Math.random()*e.length)];return console.error(`[Mock Fulfillment] Order ${t} failed`,{productId:r,quantity:a,error:n}),{success:!1,error:n,message:`Mock fulfillment failed: ${n}`,metadata:{provider:"mock",failedAt:new Date().toISOString(),productId:r,quantity:a}}}}async checkStatus(e){return await new Promise(e=>setTimeout(e,500)),{success:!0,transactionId:e,message:"Mock transaction completed",metadata:{provider:"mock",status:"completed"}}}async isProductAvailable(e){return await new Promise(e=>setTimeout(e,200)),!0}}class a{name="digiflazz";apiKey;username;baseUrl;constructor(){this.apiKey=process.env.DIGIFLAZZ_API_KEY||"",this.username=process.env.DIGIFLAZZ_USERNAME||"",this.baseUrl=process.env.DIGIFLAZZ_BASE_URL||"https://api.digiflazz.com/v1",this.apiKey&&this.username||console.warn("[Digiflazz] API credentials not configured")}async fulfill(e){if(!this.apiKey||!this.username)return{success:!1,error:"Digiflazz API credentials not configured",message:"DIGIFLAZZ_API_KEY and DIGIFLAZZ_USERNAME must be set"};throw Error("Digiflazz fulfillment not yet implemented")}async checkStatus(e){if(!this.apiKey||!this.username)return{success:!1,error:"Digiflazz API credentials not configured"};throw Error("Digiflazz status check not yet implemented")}async isProductAvailable(e){return!!this.apiKey&&!!this.username}}async function n(e,t,n){let i=n||function(e="mock"){switch(e){case"mock":return new r;case"digiflazz":return new a;default:return console.warn(`Unknown fulfillment provider type: ${e}, falling back to mock`),new r}}(process.env.FULFILLMENT_PROVIDER||"mock"),s=(await Promise.allSettled(t.map(async t=>{let r=await i.fulfill({orderId:e,productId:t.productId,quantity:t.quantity});return{productId:t.productId,result:r}}))).map((e,r)=>"fulfilled"===e.status?e.value:{productId:t[r].productId,result:{success:!1,error:e.reason?.message||"Unknown error"}}),o=s.every(e=>e.result.success),l={orderId:e,provider:i.name,items:s,timestamp:new Date().toISOString()};return{success:o,results:s,payload:l}}async function i(e){let r=await t.prisma.order.findUnique({where:{id:e},include:{items:!0}});if(!r)throw Error(`Order ${e} not found`);if("PAID"!==r.status)throw Error(`Order ${e} is not in PAID status`);let a=await n(e,r.items.map(e=>({productId:e.productId,quantity:e.quantity}))),i=a.success?"SUCCESS":"FAILED",s=a.success?null:a.results.filter(e=>!e.result.success).map(e=>e.result.error||"Unknown error").join("; ");await t.prisma.order.update({where:{id:e},data:{fulfillmentStatus:i,fulfillmentAttemptCount:{increment:1},fulfillmentLastError:s,fulfillmentPayloadJson:a.payload,...a.success&&{status:"FULFILLED"}}}),console.log(`[Fulfillment] Order ${e} processed: ${i}`,{attemptCount:r.fulfillmentAttemptCount+1,lastError:s})}async function s(e){try{return(await t.prisma.order.updateMany({where:{id:e,status:"PAID",fulfillmentStatus:{in:["NOT_STARTED","FAILED"]},fulfillmentAttemptCount:{lt:3}},data:{fulfillmentStatus:"PENDING"}})).count>0}catch(t){return console.error(`[Fulfillment] Failed to start fulfillment for order ${e}:`,t),!1}}e.s(["processOrderFulfillment",()=>i,"tryStartFulfillment",()=>s],54478)},36632,e=>{"use strict";var t=e.i(54799);function r(e,r,a,n){return t.default.createHash("md5").update(`${e}:${r}:${n}`).digest("hex").toUpperCase().toUpperCase()===a.toUpperCase()}function a(e){var r;let a,n=process.env.ROBOKASSA_MERCHANT_LOGIN,i=process.env.ROBOKASSA_PASSWORD1,s="true"===process.env.ROBOKASSA_TEST_MODE,o=process.env.ROBOKASSA_API_BASE_URL||"https://auth.robokassa.ru/Merchant/Index.aspx";if(!n||!i)throw Error("ROBOKASSA_MERCHANT_LOGIN or ROBOKASSA_PASSWORD1 is not configured");let l=(e.amountKopeks/100).toFixed(2),u=e.orderId,d=(r=parseFloat(l),a=`${n}:${r}:${u}:${i}`,t.default.createHash("md5").update(a).digest("hex").toUpperCase()),c=new URLSearchParams({MerchantLogin:n,OutSum:l,InvId:String(u),Description:e.description,SignatureValue:d,IsTest:s?"1":"0"});e.email&&c.append("Email",e.email),e.culture&&c.append("Culture",e.culture),e.successUrl&&c.append("SuccessURL",e.successUrl),e.failUrl&&c.append("FailURL",e.failUrl);let p=`${o}?${c.toString()}`;return{paymentId:String(u),paymentUrl:p}}function n(e){let t=t=>{if(e instanceof URLSearchParams)return e.get(t)||"";let r=e[t];return Array.isArray(r)?r[0]||"":r||""},r=t("OutSum"),a=t("InvId"),n=t("SignatureValue"),i=t("Culture");if(!r||!a||!n)throw Error("Missing required parameters in Robokassa notification");let s=parseFloat(r),o=parseInt(a,10);if(isNaN(s)||isNaN(o))throw Error("Invalid OutSum or InvId in Robokassa notification");return{outSum:s,invId:o,signatureValue:n,culture:i||void 0}}e.s(["initPayment",()=>a,"parseNotificationParams",()=>n,"verifyNotificationSignature",()=>r])},46650,e=>{"use strict";var t=e.i(46820),r=e.i(99839),a=e.i(38209),n=e.i(1647),i=e.i(65720),s=e.i(95367),o=e.i(90115),l=e.i(20881),u=e.i(48661),d=e.i(14834),c=e.i(62865),p=e.i(95897),m=e.i(48383),f=e.i(55301),h=e.i(53757),w=e.i(66508),g=e.i(93695);e.i(46459);var R=e.i(74586);e.i(37219);var A=e.i(90177),S=e.i(36632),v=e.i(54478);async function y(e){let t,r;try{let r=await e.text();t=new URLSearchParams(r)}catch(e){return console.error("Failed to parse Robokassa notification body:",e),new Response("Bad Request",{status:400})}let a=process.env.ROBOKASSA_PASSWORD2;if(!a)return console.error("ROBOKASSA_PASSWORD2 is not configured"),new Response("Server Error",{status:500});try{r=(0,S.parseNotificationParams)(t)}catch(e){return console.error("Failed to parse notification parameters:",e),new Response("Bad Request",{status:400})}let{outSum:n,invId:i,signatureValue:s}=r;if(!(0,S.verifyNotificationSignature)(n,i,s,a))return console.warn("Robokassa notification signature invalid",{outSum:n,invId:i,receivedSignature:s}),new Response("Bad Signature",{status:400});let o=await A.prisma.order.findUnique({where:{id:i}});if(!o)return console.warn("Order not found for Robokassa notification",{invId:i}),new Response("OK",{status:200});let l=Math.round(100*n);if(o.totalAmountKopeks!==l)return console.warn("Amount mismatch in Robokassa notification",{expected:o.totalAmountKopeks,actual:l,orderId:o.id}),new Response("Amount mismatch",{status:400});try{await A.prisma.paymentNotificationLog.create({data:{providerPaymentId:String(i),status:"PAID",payloadJson:JSON.stringify({OutSum:n,InvId:i,SignatureValue:s,Culture:r.culture})}})}catch(e){console.warn("Failed to insert PaymentNotificationLog",e)}if("PAID"!==o.status&&"FULFILLED"!==o.status)if(await A.prisma.order.update({where:{id:o.id},data:{status:"PAID",providerPaymentId:String(i),paidAt:new Date}}),await (0,v.tryStartFulfillment)(o.id))(0,v.processOrderFulfillment)(o.id).catch(e=>{console.error(`[Fulfillment] Failed to process order ${o.id}:`,e),A.prisma.order.update({where:{id:o.id},data:{fulfillmentStatus:"FAILED",fulfillmentLastError:(e instanceof Error?e.message:String(e))||"Unknown error",fulfillmentAttemptCount:{increment:1}}}).catch(e=>{console.error(`[Fulfillment] Failed to update order ${o.id} status:`,e)})});else{let e=await A.prisma.order.findUnique({where:{id:o.id},select:{fulfillmentAttemptCount:!0,fulfillmentStatus:!0}});e&&e.fulfillmentAttemptCount>=3?(console.warn(`[Fulfillment] Order ${o.id} reached max attempts (${e.fulfillmentAttemptCount}), requires manual retry`),"FAILED"!==e.fulfillmentStatus&&await A.prisma.order.update({where:{id:o.id},data:{fulfillmentStatus:"FAILED",fulfillmentLastError:"Превышено максимальное количество попыток. Обратитесь в поддержку."}})):console.log(`[Fulfillment] Order ${o.id} fulfillment already started or completed`)}return new Response("OK",{status:200,headers:{"Content-Type":"text/plain; charset=utf-8"}})}e.s(["POST",()=>y],38441);var I=e.i(38441);let E=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/payments/robokassa/notification/route",pathname:"/api/payments/robokassa/notification",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/payments/robokassa/notification/route.ts",nextConfigOutput:"",userland:I}),{workAsyncStorage:x,workUnitAsyncStorage:O,serverHooks:P}=E;function C(){return(0,a.patchFetch)({workAsyncStorage:x,workUnitAsyncStorage:O})}async function k(e,t,a){E.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let A="/api/payments/robokassa/notification/route";A=A.replace(/\/index$/,"")||"/";let S=await E.prepare(e,t,{srcPage:A,multiZoneDraftMode:!1});if(!S)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:v,params:y,nextConfig:I,parsedUrl:x,isDraftMode:O,prerenderManifest:P,routerServerContext:C,isOnDemandRevalidate:k,revalidateOnlyGenerated:b,resolvedPathname:D,clientReferenceManifest:_,serverActionsManifest:F}=S,U=(0,l.normalizeAppPath)(A),N=!!(P.dynamicRoutes[U]||P.routes[D]),T=async()=>((null==C?void 0:C.render404)?await C.render404(e,t,x,!1):t.end("This page could not be found"),null);if(N&&!O){let e=!!P.routes[D],t=P.dynamicRoutes[U];if(t&&!1===t.fallback&&!e){if(I.experimental.adapterPath)return await T();throw new g.NoFallbackError}}let L=null;!N||E.isDev||O||(L="/index"===(L=D)?"/":L);let M=!0===E.isDev||!N,$=N&&!M;F&&_&&(0,s.setReferenceManifestsSingleton)({page:A,clientReferenceManifest:_,serverActionsManifest:F,serverModuleMap:(0,o.createServerModuleMap)({serverActionsManifest:F})});let q=e.method||"GET",K=(0,i.getTracer)(),H=K.getActiveScopeSpan(),B={params:y,prerenderManifest:P,renderOpts:{experimental:{authInterrupts:!!I.experimental.authInterrupts},cacheComponents:!!I.cacheComponents,supportsDynamicResponse:M,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:I.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a)=>E.onRequestError(e,t,a,C)},sharedContext:{buildId:v}},z=new u.NodeNextRequest(e),j=new u.NodeNextResponse(t),G=d.NextRequestAdapter.fromNodeNextRequest(z,(0,d.signalFromNodeResponse)(t));try{let s=async e=>E.handle(G,B).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=K.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${q} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${q} ${A}`)}),o=!!(0,n.getRequestMeta)(e,"minimalMode"),l=async n=>{var i,l;let u=async({previousCacheEntry:r})=>{try{if(!o&&k&&b&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await s(n);e.fetchMetrics=B.renderOpts.fetchMetrics;let l=B.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let u=B.renderOpts.collectedTags;if(!N)return await (0,m.sendResponse)(z,j,i,B.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,f.toNodeOutgoingHttpHeaders)(i.headers);u&&(t[w.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==B.renderOpts.collectedRevalidate&&!(B.renderOpts.collectedRevalidate>=w.INFINITE_CACHE)&&B.renderOpts.collectedRevalidate,a=void 0===B.renderOpts.collectedExpire||B.renderOpts.collectedExpire>=w.INFINITE_CACHE?void 0:B.renderOpts.collectedExpire;return{value:{kind:R.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await E.onRequestError(e,t,{routerKind:"App Router",routePath:A,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:$,isOnDemandRevalidate:k})},C),t}},d=await E.handleResponse({req:e,nextConfig:I,cacheKey:L,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:P,isRoutePPREnabled:!1,isOnDemandRevalidate:k,revalidateOnlyGenerated:b,responseGenerator:u,waitUntil:a.waitUntil,isMinimalMode:o});if(!N)return null;if((null==d||null==(i=d.value)?void 0:i.kind)!==R.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(l=d.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",k?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),O&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let c=(0,f.fromNodeOutgoingHttpHeaders)(d.value.headers);return o&&N||c.delete(w.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||c.get("Cache-Control")||c.set("Cache-Control",(0,h.getCacheControlHeader)(d.cacheControl)),await (0,m.sendResponse)(z,j,new Response(d.value.body,{headers:c,status:d.value.status||200})),null};H?await l(H):await K.withPropagatedContext(e.headers,()=>K.trace(c.BaseServerSpan.handleRequest,{spanName:`${q} ${A}`,kind:i.SpanKind.SERVER,attributes:{"http.method":q,"http.target":e.url}},l))}catch(t){if(t instanceof g.NoFallbackError||await E.onRequestError(e,t,{routerKind:"App Router",routePath:U,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:$,isOnDemandRevalidate:k})}),N)throw t;return await (0,m.sendResponse)(z,j,new Response(null,{status:500})),null}}e.s(["handler",()=>k,"patchFetch",()=>C,"routeModule",()=>E,"serverHooks",()=>P,"workAsyncStorage",()=>x,"workUnitAsyncStorage",()=>O],46650)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__40fdb61e._.js.map