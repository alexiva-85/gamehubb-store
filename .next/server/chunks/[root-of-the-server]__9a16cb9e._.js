module.exports=[18622,(e,t,r)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},70406,(e,t,r)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},93695,(e,t,r)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},54799,(e,t,r)=>{t.exports=e.x("crypto",()=>require("crypto"))},29173,(e,t,r)=>{t.exports=e.x("@prisma/client",()=>require("@prisma/client"))},37219,90177,e=>{"use strict";var t=e.i(29173);let r=new Proxy({},{get(e,r){let a=function(){if(globalThis.__prisma)return globalThis.__prisma;if(!process.env.DATABASE_URL)throw Error("DATABASE_URL is not configured");return new t.PrismaClient({log:["error"]})}(),n=a[r];return"function"==typeof n?n.bind(a):n}});e.s(["prisma",0,r],90177),e.s([],37219)},54478,e=>{"use strict";e.i(37219);var t=e.i(90177);class r{name="mock";async fulfill(e){let{orderId:t,productId:r,quantity:a}=e,n=2e3*Math.random()+1e3;if(await new Promise(e=>setTimeout(e,n)),Math.random()>.05){let e=`MOCK-${t}-${Date.now()}-${Math.random().toString(36).substring(7)}`;return console.log(`[Mock Fulfillment] Order ${t} fulfilled successfully`,{productId:r,quantity:a,transactionId:e}),{success:!0,transactionId:e,message:`Mock fulfillment completed for order ${t}`,metadata:{provider:"mock",fulfilledAt:new Date().toISOString(),productId:r,quantity:a}}}{let e=["Insufficient stock","Product temporarily unavailable","Processing timeout","Invalid product configuration"],n=e[Math.floor(Math.random()*e.length)];return console.error(`[Mock Fulfillment] Order ${t} failed`,{productId:r,quantity:a,error:n}),{success:!1,error:n,message:`Mock fulfillment failed: ${n}`,metadata:{provider:"mock",failedAt:new Date().toISOString(),productId:r,quantity:a}}}}async checkStatus(e){return await new Promise(e=>setTimeout(e,500)),{success:!0,transactionId:e,message:"Mock transaction completed",metadata:{provider:"mock",status:"completed"}}}async isProductAvailable(e){return await new Promise(e=>setTimeout(e,200)),!0}}class a{name="digiflazz";apiKey;username;baseUrl;constructor(){this.apiKey=process.env.DIGIFLAZZ_API_KEY||"",this.username=process.env.DIGIFLAZZ_USERNAME||"",this.baseUrl=process.env.DIGIFLAZZ_BASE_URL||"https://api.digiflazz.com/v1",this.apiKey&&this.username||console.warn("[Digiflazz] API credentials not configured")}async fulfill(e){if(!this.apiKey||!this.username)return{success:!1,error:"Digiflazz API credentials not configured",message:"DIGIFLAZZ_API_KEY and DIGIFLAZZ_USERNAME must be set"};throw Error("Digiflazz fulfillment not yet implemented")}async checkStatus(e){if(!this.apiKey||!this.username)return{success:!1,error:"Digiflazz API credentials not configured"};throw Error("Digiflazz status check not yet implemented")}async isProductAvailable(e){return!!this.apiKey&&!!this.username}}async function n(e,t,n){let i=n||function(e="mock"){switch(e){case"mock":return new r;case"digiflazz":return new a;default:return console.warn(`Unknown fulfillment provider type: ${e}, falling back to mock`),new r}}(process.env.FULFILLMENT_PROVIDER||"mock"),s=(await Promise.allSettled(t.map(async t=>{let r=await i.fulfill({orderId:e,productId:t.productId,quantity:t.quantity});return{productId:t.productId,result:r}}))).map((e,r)=>"fulfilled"===e.status?e.value:{productId:t[r].productId,result:{success:!1,error:e.reason?.message||"Unknown error"}}),o=s.every(e=>e.result.success),l={orderId:e,provider:i.name,items:s,timestamp:new Date().toISOString()};return{success:o,results:s,payload:l}}async function i(e){let r=await t.prisma.order.findUnique({where:{id:e},include:{items:!0}});if(!r)throw Error(`Order ${e} not found`);if("PAID"!==r.status)throw Error(`Order ${e} is not in PAID status`);let a=await n(e,r.items.map(e=>({productId:e.productId,quantity:e.quantity}))),i=a.success?"SUCCESS":"FAILED",s=a.success?null:a.results.filter(e=>!e.result.success).map(e=>e.result.error||"Unknown error").join("; ");await t.prisma.order.update({where:{id:e},data:{fulfillmentStatus:i,fulfillmentAttemptCount:{increment:1},fulfillmentLastError:s,fulfillmentPayloadJson:a.payload,...a.success&&{status:"FULFILLED"}}}),console.log(`[Fulfillment] Order ${e} processed: ${i}`,{attemptCount:r.fulfillmentAttemptCount+1,lastError:s})}async function s(e){try{return(await t.prisma.order.updateMany({where:{id:e,status:"PAID",fulfillmentStatus:{in:["NOT_STARTED","FAILED"]},fulfillmentAttemptCount:{lt:3}},data:{fulfillmentStatus:"PENDING"}})).count>0}catch(t){return console.error(`[Fulfillment] Failed to start fulfillment for order ${e}:`,t),!1}}e.s(["processOrderFulfillment",()=>i,"tryStartFulfillment",()=>s],54478)},75417,e=>{"use strict";var t=e.i(46820),r=e.i(99839),a=e.i(38209),n=e.i(1647),i=e.i(65720),s=e.i(95367),o=e.i(90115),l=e.i(20881),u=e.i(48661),d=e.i(14834),c=e.i(62865),p=e.i(95897),f=e.i(48383),m=e.i(55301),h=e.i(53757),w=e.i(66508),y=e.i(93695);e.i(46459);var g=e.i(74586);e.i(37219);var A=e.i(90177),v=e.i(54799),R=e.i(54478);async function E(e){let t;try{t=await e.json()}catch{return new Response("Bad Request",{status:400})}let r=process.env.TBANK_PASSWORD;if(!r)return console.error("TBANK_PASSWORD is not configured"),new Response("Server Error",{status:500});if(!function(e,t){let{Token:r}=e;if(!r)return!1;let a=Object.entries(e).filter(([e,t])=>"Token"!==e&&"DATA"!==e&&"Data"!==e&&"Receipt"!==e&&null!=t&&"object"!=typeof t).sort(([e],[t])=>e<t?-1:+(e>t)).map(([,e])=>String(e)).join("")+t;return v.default.createHash("sha256").update(a).digest("hex")===r}(t,r))return console.warn("T-Bank notification signature invalid"),new Response("Bad Token",{status:400});let a=t.OrderId,n=t.PaymentId,i=t.Status,s=t.Amount;if(!i||"string"!=typeof i||"number"!=typeof s)return new Response("Bad Request",{status:400});let o="number"==typeof a?await A.prisma.order.findUnique({where:{id:a}}):null;if(o||"string"!=typeof n||(o=await A.prisma.order.findFirst({where:{providerPaymentId:n}})),!o)return console.warn("Order not found for T-Bank notification",{orderId:a,paymentId:n}),new Response("OK",{status:200});if(o.totalAmountKopeks!==s)return console.warn("Amount mismatch in T-Bank notification",{expected:o.totalAmountKopeks,actual:s}),new Response("Amount mismatch",{status:400});try{await A.prisma.paymentNotificationLog.create({data:{providerPaymentId:String(n??o.providerPaymentId??""),status:i,payloadJson:JSON.stringify(t)}})}catch(e){console.warn("Failed to insert PaymentNotificationLog",e)}if("AUTHORIZED"===i)("NEW"===o.status||"PAYMENT_CREATED"===o.status)&&await A.prisma.order.update({where:{id:o.id},data:{status:"AUTHORIZED",providerPaymentId:"string"==typeof n?n:o.providerPaymentId}});else if("CONFIRMED"===i&&"PAID"!==o.status&&"FULFILLED"!==o.status)if(await A.prisma.order.update({where:{id:o.id},data:{status:"PAID",providerPaymentId:"string"==typeof n?n:o.providerPaymentId,paidAt:new Date}}),await (0,R.tryStartFulfillment)(o.id))(0,R.processOrderFulfillment)(o.id).catch(e=>{console.error(`[Fulfillment] Failed to process order ${o.id}:`,e),A.prisma.order.update({where:{id:o.id},data:{fulfillmentStatus:"FAILED",fulfillmentLastError:(e instanceof Error?e.message:String(e))||"Unknown error",fulfillmentAttemptCount:{increment:1}}}).catch(e=>{console.error(`[Fulfillment] Failed to update order ${o.id} status:`,e)})});else{let e=await A.prisma.order.findUnique({where:{id:o.id},select:{fulfillmentAttemptCount:!0,fulfillmentStatus:!0}});e&&e.fulfillmentAttemptCount>=3?(console.warn(`[Fulfillment] Order ${o.id} reached max attempts (${e.fulfillmentAttemptCount}), requires manual retry`),"FAILED"!==e.fulfillmentStatus&&await A.prisma.order.update({where:{id:o.id},data:{fulfillmentStatus:"FAILED",fulfillmentLastError:"Превышено максимальное количество попыток. Обратитесь в поддержку."}})):console.log(`[Fulfillment] Order ${o.id} fulfillment already started or completed`)}return new Response("OK",{status:200,headers:{"Content-Type":"text/plain"}})}e.s(["POST",()=>E],39757);var I=e.i(39757);let x=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/payments/tbank/notification/route",pathname:"/api/payments/tbank/notification",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/payments/tbank/notification/route.ts",nextConfigOutput:"",userland:I}),{workAsyncStorage:P,workUnitAsyncStorage:S,serverHooks:D}=x;function k(){return(0,a.patchFetch)({workAsyncStorage:P,workUnitAsyncStorage:S})}async function C(e,t,a){x.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let A="/api/payments/tbank/notification/route";A=A.replace(/\/index$/,"")||"/";let v=await x.prepare(e,t,{srcPage:A,multiZoneDraftMode:!1});if(!v)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:R,params:E,nextConfig:I,parsedUrl:P,isDraftMode:S,prerenderManifest:D,routerServerContext:k,isOnDemandRevalidate:C,revalidateOnlyGenerated:T,resolvedPathname:O,clientReferenceManifest:b,serverActionsManifest:F}=v,_=(0,l.normalizeAppPath)(A),N=!!(D.dynamicRoutes[_]||D.routes[O]),U=async()=>((null==k?void 0:k.render404)?await k.render404(e,t,P,!1):t.end("This page could not be found"),null);if(N&&!S){let e=!!D.routes[O],t=D.dynamicRoutes[_];if(t&&!1===t.fallback&&!e){if(I.experimental.adapterPath)return await U();throw new y.NoFallbackError}}let M=null;!N||x.isDev||S||(M="/index"===(M=O)?"/":M);let L=!0===x.isDev||!N,q=N&&!L;F&&b&&(0,s.setReferenceManifestsSingleton)({page:A,clientReferenceManifest:b,serverActionsManifest:F,serverModuleMap:(0,o.createServerModuleMap)({serverActionsManifest:F})});let $=e.method||"GET",K=(0,i.getTracer)(),j=K.getActiveScopeSpan(),H={params:E,prerenderManifest:D,renderOpts:{experimental:{authInterrupts:!!I.experimental.authInterrupts},cacheComponents:!!I.cacheComponents,supportsDynamicResponse:L,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:I.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a)=>x.onRequestError(e,t,a,k)},sharedContext:{buildId:R}},z=new u.NodeNextRequest(e),B=new u.NodeNextResponse(t),Z=d.NextRequestAdapter.fromNodeNextRequest(z,(0,d.signalFromNodeResponse)(t));try{let s=async e=>x.handle(Z,H).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=K.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${$} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${$} ${A}`)}),o=!!(0,n.getRequestMeta)(e,"minimalMode"),l=async n=>{var i,l;let u=async({previousCacheEntry:r})=>{try{if(!o&&C&&T&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await s(n);e.fetchMetrics=H.renderOpts.fetchMetrics;let l=H.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let u=H.renderOpts.collectedTags;if(!N)return await (0,f.sendResponse)(z,B,i,H.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(i.headers);u&&(t[w.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==H.renderOpts.collectedRevalidate&&!(H.renderOpts.collectedRevalidate>=w.INFINITE_CACHE)&&H.renderOpts.collectedRevalidate,a=void 0===H.renderOpts.collectedExpire||H.renderOpts.collectedExpire>=w.INFINITE_CACHE?void 0:H.renderOpts.collectedExpire;return{value:{kind:g.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await x.onRequestError(e,t,{routerKind:"App Router",routePath:A,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:C})},k),t}},d=await x.handleResponse({req:e,nextConfig:I,cacheKey:M,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:D,isRoutePPREnabled:!1,isOnDemandRevalidate:C,revalidateOnlyGenerated:T,responseGenerator:u,waitUntil:a.waitUntil,isMinimalMode:o});if(!N)return null;if((null==d||null==(i=d.value)?void 0:i.kind)!==g.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(l=d.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",C?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),S&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let c=(0,m.fromNodeOutgoingHttpHeaders)(d.value.headers);return o&&N||c.delete(w.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||c.get("Cache-Control")||c.set("Cache-Control",(0,h.getCacheControlHeader)(d.cacheControl)),await (0,f.sendResponse)(z,B,new Response(d.value.body,{headers:c,status:d.value.status||200})),null};j?await l(j):await K.withPropagatedContext(e.headers,()=>K.trace(c.BaseServerSpan.handleRequest,{spanName:`${$} ${A}`,kind:i.SpanKind.SERVER,attributes:{"http.method":$,"http.target":e.url}},l))}catch(t){if(t instanceof y.NoFallbackError||await x.onRequestError(e,t,{routerKind:"App Router",routePath:_,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:C})}),N)throw t;return await (0,f.sendResponse)(z,B,new Response(null,{status:500})),null}}e.s(["handler",()=>C,"patchFetch",()=>k,"routeModule",()=>x,"serverHooks",()=>D,"workAsyncStorage",()=>P,"workUnitAsyncStorage",()=>S],75417)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__9a16cb9e._.js.map