// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Product {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  priceCents  Int
  imageUrl    String?
  currency    String   @default("RUB")
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  orderItems  OrderItem[]
}

model Order {
  id          Int         @id @default(autoincrement())
  tgUserId    String
  status      OrderStatus @default(NEW)
  totalCents  Int
  totalAmountKopeks Int
  currency    String      @default("RUB")
  provider    String      @default("ROBOKASSA")
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  items       OrderItem[]

  providerPaymentId   String?   @unique
  providerPaymentUrl  String?
  paidAt      DateTime?

  fulfillmentStatus   FulfillmentStatus @default(NOT_STARTED)
  fulfillmentAttemptCount Int          @default(0)
  fulfillmentLastError    String?
  fulfillmentPayloadJson   Json?
}

model OrderItem {
  id          Int     @id @default(autoincrement())
  order       Order   @relation(fields: [orderId], references: [id])
  orderId     Int
  product     Product @relation(fields: [productId], references: [id])
  productId   Int
  quantity    Int
  priceCents  Int
}

enum OrderStatus {
  NEW
  PAYMENT_CREATED
  AUTHORIZED
  PAID
  FULFILLED
  CANCELED
}

enum FulfillmentStatus {
  NOT_STARTED
  PENDING
  SUCCESS
  FAILED
}

model PaymentNotificationLog {
  id               Int      @id @default(autoincrement())
  providerPaymentId String
  status           String
  payloadJson      String
  createdAt        DateTime @default(now())

  @@unique([providerPaymentId, status])
}
